#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

export CGO_ENABLED := 0
export GOCACHE := /tmp/go-build
export GOPATH := $(CURDIR)/go

%:
	dh $@

override_dh_auto_clean:
	dh_auto_clean
	chmod -R u+w $(GOPATH) 2>/dev/null || true
	rm -rf $(GOPATH) || true
	rm -rf bin

override_dh_auto_build:
	# Generate protobuf files first
	mkdir -p api/proto/firecracker/v1
	export PATH="$$PATH:$(go env GOPATH)/bin" && \
		protoc --go_out=. --go_opt=paths=source_relative \
		--go-grpc_out=. --go-grpc_opt=paths=source_relative \
		api/proto/firecracker/v1/firecracker.proto
	# Build the binary with system Go
	mkdir -p bin
	go build -v -ldflags="-s -w" -o bin/fc-agent ./cmd/fc-agent

override_dh_auto_test:
	# Skip tests during package build
	@echo "Skipping tests (run separately with: make test)"

override_dh_auto_install:
	# Install binary
	install -D -m 0755 bin/fc-agent debian/firecracker-agent/usr/bin/fc-agent
	# Install systemd service
	install -D -m 0644 scripts/fc-agent.service debian/firecracker-agent/lib/systemd/system/fc-agent.service
	# Install configuration
	install -D -m 0644 configs/agent.yaml debian/firecracker-agent/etc/firecracker-agent/agent.yaml
	# Create directories
	install -d -m 0755 debian/firecracker-agent/var/lib/firecracker/vms
	install -d -m 0755 debian/firecracker-agent/var/lib/firecracker/images
	install -d -m 0755 debian/firecracker-agent/var/log/firecracker-agent

override_dh_installsystemd:
	dh_installsystemd --name=fc-agent --no-start --no-enable

override_dh_builddeb:
	dh_builddeb -- -Zgzip
